---
layout: post
title: è®°ä¸€æ¬¡ ImageMagick jpeg ç¼©æ”¾æ€§èƒ½è°ƒä¼˜
tags: ImageMagick,jpeg
---

ç”±äºåŒäº‹äº†è°ƒå²—ï¼Œæ¥æ‰‹äº†ä¸€ä¸ªç®€å•çš„ç¼©ç•¥å›¾æœåŠ¡ï¼Œå¤§ä½¬çœ‹ä¹‹å‰çš„ä»£ç è¿‡äºæ··(la)ä¹±(ji)å¤§æ‰‹ä¸€æŒ¥å¸¦ç€æˆ‘ä»¬ç”¨ C++ é‡æ„äº†è¿™ä¸ªæœåŠ¡ï¼Œæ•…äº‹å°±å‘ç”Ÿåœ¨æ–°æœåŠ¡ä¸Šçº¿å‡ å‘¨åã€‚åœ¨ä¸€ä¸ªæ„‰å¿«çš„å‘¨äº”ä¸‹ç­åï¼Œæ­£åœ¨æ¡Œä¸Šåƒç€ç«é”…çªç„¶æ”¶åˆ°å‘Šè­¦æœåŠ¡å¼€å§‹è¶…æ—¶ï¼Œèµ¶ç´§è”ç³»åŒäº‹é‡å¯äº†ä¸€æ³¢ï¼Œä½†æ˜¯æ•ˆæœç”šå¾®ã€‚æ— å¥ˆç´§æ€¥åˆ‡å›æ¥æ—§æœåŠ¡ã€‚

äº‹åè¿›è¡Œåˆ†æå‘ç°æ˜¯å› ä¸ºæœ‰ä¸€å¼ éå¸¸é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡å¯¼è‡´çš„ï¼Œç”±äºä¸Šä¼ æ—¶åªé™åˆ¶äº†ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ä½“ç§¯å¤§å°æ²¡æœ‰æ£€æŸ¥å›¾ç‰‡å®é™…åˆ†è¾¨ç‡å†åŠ ä¸Šä¸Šæ¸¸æœåŠ¡çš„ä¸åˆç†é‡è¯•ï¼Œå‡ ä¹è®©è¿™å¼ å›¾ç‰‡å æ»¡äº†æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œæœ€ç»ˆå¯¼è‡´é›ªå´©ã€‚

![ç½ªé­ç¥¸é¦–.jpeg](/images/2020-10-11-imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg)

ç”±äºå›¾ç‰‡å¤ªå¤§ä¸Šé¢çš„æ˜¯ç¼©ç•¥å›¾ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç‚¹å‡»è¿™é‡Œä¸‹è½½åŸå›¾[ç½ªé­ç¥¸é¦–.jpeg](/images/2020-10-11-imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c.jpeg), åŸå›¾çš„å¤§å°å¤§å°çº¦ 24000x17280 æ€»åƒç´ è¶…è¿‡4äº¿

### é—®é¢˜é‡ç°

ç«Ÿç„¶çŸ¥é“äº†é—®é¢˜æ˜¯è¶…é«˜åˆ†è¾¨ç‡ï¼Œå°±éœ€è¦çœ‹çœ‹æœ‰æ²¡æœ‰å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ã€‚å›¾ç‰‡å¤„ç†æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„æ˜¯ ImageMagick è¿™ä¸ªå¼€æºåº“ï¼Œé¦–å…ˆå°†æœåŠ¡æœ€å°åŒ–ï¼Œç¼©ç•¥å›¾çš„ä¸»è¦é€»è¾‘å¤§æ¦‚å°±è¿™å‡ è¡Œ

```c++
Magick::Image im;
im.read("big-img.jpeg");
im.filterType(Magick::LanczosFilter);
im.resize(Magick::Geometry(400, 288));
im.write("thumbnail.jpeg");
```

é¦–å…ˆç”¨å‡ºé—®é¢˜çš„å›¾ç‰‡è·‘ä¸€ä¸‹è¯•è¯• (å› ä¸ºä¸€äº›èµ„æºç®¡ç†é—®é¢˜ï¼ŒImageMagick åœ¨è¿™é‡Œæ²¡æœ‰å¼€å¯ openmpï¼Œéƒ½æ˜¯å•çº¿ç¨‹å·¥ä½œçš„)

```
User time (seconds): 9.71
System time (seconds): 0.96
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4954472
```

åœ¨æˆ‘è‡ªå·±ç”µè„‘ä¸Šå¤§çº¦éœ€è¦ 10s å ç”¨çº¦ 4G å†…å­˜ï¼Œå®é™…åœ¨å…¬å¸æœåŠ¡å™¨å¤§çº¦éœ€è¦ 15s å·¦å³ (AMD Yes!)ï¼Œå¯¹äºä¸€ä¸ªåœ¨çº¿æœåŠ¡å¾ˆæ˜æ˜¾æ˜¯ä¸èƒ½æ¥å—çš„ã€‚é€šè¿‡ perf å·¥å…·å¯ä»¥çœ‹å‡ºï¼ŒCPU ä¸»è¦éƒ½æ˜¯èŠ±åœ¨ resize çš„è¿‡ç¨‹ä¸­ã€‚

è°ƒæ•´ filterType å¯ä»¥èµ·åˆ°ä¼˜åŒ–çš„å·¦å³ï¼Œæ¯”å¦‚å°†ä½†æ˜¯è°ƒæ•´ filterType åˆ° PointFilterï¼Œå¤„ç†æ—¶é—´ä¸€ä¸‹å­å°±å¯ä»¥æ¥åˆ° 1.4s å†…å­˜å ç”¨è¿˜æ˜¯ 4Gï¼Œä½†æ˜¯å›¾ç‰‡æ•ˆæœåŸºæœ¬å°±ä¸èƒ½æ¥å—äº†

```
User time (seconds): 1.40
System time (seconds): 0.91
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4953288
```

![pointfilter-1.jpeg](/images/2020-10-11-imagemagick-tuning/pointfilter-1.jpeg)

è€Œä¸”ä¿®æ”¹ filterType å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–å›¾ç‰‡æœ€ç»ˆå‘ˆç°çš„æ•ˆæœä¸çº¦å®šçš„ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ filterType åŸºæœ¬ä¸Šæ˜¯ä¸èƒ½ä¿®æ”¹çš„ã€‚

### ä» ImageMagick å…¥æ‰‹

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘åˆå»ç¿»äº†ä¸€ä¸‹ ImageMagick çš„æ–‡æ¡£ä¸ä»£ç ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å·²ç»æœ‰å¯¹è¿™ç§è¶…é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡åšç¼©ç•¥å›¾çš„ä¼˜åŒ–äº†ï¼Œæ¯•ç«Ÿè¿™ä¸ªæ˜¯å¾ˆå¸¸è§çš„éœ€æ±‚ã€‚æœç„¶ ImageMagick é™¤äº† `resize` è¿˜æä¾›äº†ä¸€ä¸ª `thumbnail` çš„æ–¹æ³•ï¼Œ`thumbnail` é¡¾åæ€ä¹‰å°±æ˜¯ç”¨æ¥ç”Ÿæˆç¼©ç•¥å›¾çš„ï¼Œç¿»äº†ä¸€ä¸‹ä»£ç  `thumbnail` ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹

1. å¯¹åŸå›¾è¿›è¡Œç®€å•é‡‡æ ·åŠæ¯éš” 5 ä¸ªåƒç´ ç‚¹å–ä¸€ä¸ªï¼Œç­‰äºå°†åŸå›¾é•¿å®½éƒ½ç¼©å°åˆ°ä»¥å‰çš„äº”åˆ†ä¹‹ä¸€
2. è¿›è¡Œæ™®é€š `resize` æ“ä½œ

å› ä¸ºç¬¬ä¸€æ­¥çš„é‡‡æ ·è¿‡ç¨‹éå¸¸æš´åŠ›ï¼Œæ‰€æœ‰åªæœ‰åˆ°ç¼©ç•¥å›¾çš„å¤§å°æ˜¯åŸå›¾é¢ç§¯çš„ 10% ä»¥ä¸‹è€Œä¸”åŸå›¾çš„é•¿å®½éƒ½éœ€è¦å¤§äº25åƒç´ ï¼Œå¦åˆ™éƒ½ä¼šé™çº§ä¸ºæ™®é€šçš„ `resize` æ“ä½œ

ç®€å•ä¿®æ”¹ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•

```c++
Magick::Image im;
im.read("big-img.jpeg");
im.filterType(Magick::LanczosFilter);
im.thumbnail(Magick::Geometry(400, 288));
im.write("thumbnail.jpeg");
```

æ”¹ç”¨ `thumbnail` è€—æ—¶ä¸€ä¸‹å­é™åˆ°åˆ° 1.4s å·¦å³ï¼ŒåŸºæœ¬å’Œä½¿ç”¨ PointFilter æ€§èƒ½å·®ä¸å¤šï¼Œè€Œä¸”æœ€ç»ˆè¾“å‡ºçš„å›¾ç‰‡ä¸ç›´æ¥è¿›è¡Œ `resize` çš„ç»“æœä»è‚‰çœ¼ä¸ŠåŸºæœ¬æ²¡æœ‰å·®è·ï¼Œä½†æ˜¯ä»ç„¶ä¼šå ç”¨çº¦ 4G å·¦å³çš„å†…å­˜ã€‚

```
User time (seconds): 1.44
System time (seconds): 0.90
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4912756
```

ä½¿ç”¨ `thumbnail` ç»“æœ

![thumbnail-1.jpeg](/images/2020-10-11-imagemagick-tuning/thumbnail-1.jpeg)

ç›´æ¥ `resize` ç»“æœ

![direct-resize.jpeg](/images/2020-10-11-imagemagick-tuning/direct-resize.jpeg)

### ä» jpeg æ ¼å¼å…¥æ‰‹

è™½ç„¶ä½¿ç”¨äº† `thumbnail` å¯ä»¥è§£å†³è€—æ—¶é—®é¢˜ï¼Œä½†æ˜¯ä¸€æ¬¡å¤„ç†è¦å ç”¨ 4G å¤šå†…å­˜è¿˜æ˜¯ä¸å¯æ¥å—çš„ã€‚è¦é¿å…å ç”¨è¿™ä¹ˆå¤šå†…å­˜å°±è¦é¿å…ä¸€æ¬¡æŠŠæ‰€æœ‰åƒç´ éƒ½æ”¾åˆ°å†…å­˜é‡Œé¢ï¼Œä¸€èˆ¬ä¼šæƒ³åˆ°çš„å°±æ˜¯é€šè¿‡æµå¼çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å¤§å¤§é™ä½å†…å­˜å ç”¨äº†ï¼Œå¦ä¸€ä¸ªå¼€æºçš„å›¾ç‰‡å¤„ç†åº“[libvips](https://github.com/libvips/libvips) å°±æ˜¯è¿™æ ·åšçš„ï¼Œä½†æ˜¯å°† ImageMagick æ”¹é€ æˆæµå¼å¤„ç†çš„è¯è¿™ä¸ªå·¥ä½œé‡å°±è¿‡å¤§äº†ã€‚å¯¹äº jpeg è¿™ç§å›¾ç‰‡æ ¼å¼è¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼å°±æ˜¯å¯ä»¥åœ¨è§£å‹åƒç´ çš„æ—¶å€™åšåˆ°ç±»ä¼¼ç¼©æ”¾çš„åŠŸèƒ½ï¼Œè¿™é‡Œå°±è¦ç‰µæ‰¯åˆ° jpeg çš„å·¥ä½œåŸç†äº†ï¼Œjpeg çš„å‹ç¼©ç®—æ³•åŸºäº[ç¦»æ•£ä½™å¼¦å˜æ¢](https://zh.wikipedia.org/wiki/%E7%A6%BB%E6%95%A3%E4%BD%99%E5%BC%A6%E5%8F%98%E6%8D%A2)ï¼Œè¿™é‡Œæ‰“ä¸ªæ¯”æ–¹å¯ä»¥ç†è§£ä¸º jpeg å°†åƒç´ å­˜å‚¨åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå½“è§£å‹çš„æ—¶å€™è¾“å…¥åƒç´ çš„ä¸‹æ ‡å°±èƒ½è·å¾—è¿™ä¸ªåƒç´ åŸå§‹çš„æ•°æ®ï¼Œæ¯”å¦‚å¯¹äºä¸€ä¸ª 1000x1000 çš„å›¾ç‰‡ï¼Œæˆ‘å¸Œæœ›åœ¨è§£å‹æˆä¸€å¼  500*500 å›¾ç‰‡ï¼Œé‚£æ ·åœ¨è§£å‹æ—¶æˆ‘åªè¦è·³è¿‡é‚£äº›æˆ‘ä¸éœ€è¦çš„åƒç´ ç‚¹å°±å¥½äº†ï¼Œå½“æ—¶å®é™…æƒ…å†µæ›´åŠ å¤æ‚ï¼Œjpeg ä¹Ÿä¸æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªå‡½æ•°ä¸­çš„ã€‚è¿™é‡Œæ¨èä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç» jpeg å·¥ä½œåŸç†çš„è§†é¢‘ [How JPEG works](https://www.youtube.com/watch?v=f2odrCGjOFY)

æœ‰äº†è¿™æ ·çš„ç†è®ºåŸºç¡€æˆ‘ä»¬å°±å¯ä»¥å®è·µäº†ï¼Œå…¶å® `libjpeg` å·²ç»æä¾›äº†è¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥å†è§£å‹ jpeg çš„æ—¶å€™æŒ‡å®šç¼©æ”¾çš„æ¯”ä¾‹ï¼Œæ¯”ä¾‹æœ‰å›ºå®šçš„æ¡£ä½åœ¨ 1~8 ä¹‹é—´ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å°åªèƒ½ç¼©æ”¾åˆ°åŸå›¾çš„é•¿å®½çš„å…«åˆ†ä¹‹ä¸€ã€‚ åœ¨ ImageMagick ä¸­è®¾ç½®è¿™ä¸ªå‚æ•°çš„æ–¹å¼æœ‰ç‚¹è¯¡å¼‚ï¼Œä»£ç å¦‚ä¸‹ï¼Œè¿™é‡ŒæŒ‡å®š `jpeg:size` å…¶å®åªæ˜¯æŒ‡å®šäº†ä¸€ä¸ªæœŸæœ›å€¼å®é™…è·å¾—çš„å›¾ç‰‡å¤§å°ä¼šæ˜¯ä¸€ä¸ªå¤§äºç›®æ ‡å°ºå¯¸çš„æœ€å°å€¼ï¼Œæ¯”å¦‚è¿™æ¬¡æµ‹è¯•çš„å›¾ç‰‡å®é™…è·å¾—çš„å›¾ç‰‡å¤§å°æ˜¯ 3000x2160ã€‚

```c++
Magick::Image im;
MagickCore::ImageInfo* im_info = im.imageInfo();
im_info->options = MagickCore::NewSplayTree(MagickCore::CompareSplayTreeString, (void*(*)(void*)) nullptr, (void*(*)(void*)) nullptr);
MagickCore::AddValueToSplayTree((MagickCore::SplayTreeInfo*)(im_info->options), "jpeg:size", "400x288");
im.read("big-img.jpeg");
im.filterType(Magick::LanczosFilter);
im.resize(Magick::Geometry(400, 288));
im.write("shrink-on-load.jpeg");
```

ä¼˜åŒ–ä¹‹åè€—æ—¶é™ä½åˆ°äº† 0.4s å·¦å³ï¼Œå†…å­˜ä¹Ÿé™åˆ°äº† 100Mï¼ è€Œä¸”æœ€ç»ˆè¾“å‡ºçš„ç»“æœä¸ç›´æ¥è¿›è¡Œ `resize` çš„ç»“æœä»è‚‰çœ¼ä¸ŠåŸºæœ¬æ²¡æœ‰å·®è·

```
User time (seconds): 0.42
System time (seconds): 0.02
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 104656
```

è§£å‹æ—¶ç¼©æ”¾ç»“æœ

![shrink-on-load.jpeg](/images/2020-10-11-imagemagick-tuning/shrink-on-load.jpeg)

ç›´æ¥ `resize` ç»“æœ

![shrink-on-load.jpeg](/images/2020-10-11-imagemagick-tuning/shrink-on-load.jpeg)

### é¢˜å¤–è¯

å› ä¸º ImageMagick ä¸æ”¯æŒ SIMD åŠ é€Ÿåœ¨æµ‹è¯•çš„è¿‡ç¨‹æˆ‘ä¹Ÿå°è¯•è¿‡ä½¿ç”¨æ”¯æŒ SIMD åŠ é€Ÿçš„å›¾ç‰‡åº“æ¯”å¦‚ [pillow-simd](https://github.com/uploadcare/pillow-simd) å¤„ç†å®Œæ•´åˆ†è¾¨ç‡çš„å›¾åƒä¹ŸåŸºæœ¬èƒ½æ§åˆ¶åœ¨ 1s çº§åˆ«ï¼Œä¸èƒ½åˆ©ç”¨ç°ä»£ CPU çš„åŠŸèƒ½æ˜¯ ImageMagick çš„ç¡¬ä¼¤

### æ€»ç»“

è¿™æ¬¡ç¼©ç•¥å›¾çš„ä¼˜åŒ–ï¼Œå¯¹äºè¿™ç§è¶…å¤§åˆ†è¾¨ç‡çš„å›¾ç‰‡å¤„ç†é€Ÿåº¦æå‡äº†ä¸€ä¸ªæ•°é‡çº§ (10s -> 0.5s) åŒæ—¶å†…å­˜å ç”¨ä¹Ÿé™åˆ°äº†ä¸€ä¸ªæ•°é‡çº§ (4G -> 100M)ã€‚åŸºæœ¬ä¸Šè¾¾åˆ°äº†åœ¨çº¿æœåŠ¡çš„èƒ½åŠ›ã€‚è¿™ä¸ªæ•…äº‹å‘Šè¯‰æˆ‘ä»¬æ²¡äº‹åˆ«å»é‡æ„è€æœåŠ¡ğŸ˜…

### å‚è€ƒ

- [Imagemagick thumbnails/](http://www.imagemagick.org/Usage/thumbnails/)
- [libjpeg-turbo.org/](https://libjpeg-turbo.org/)
- [Imagemagick Single Convert Command Performance](https://stackoverflow.com/questions/42022982/imagemagick-single-convert-command-performance)
- [How JPEG works](https://www.youtube.com/watch?v=f2odrCGjOFY)
