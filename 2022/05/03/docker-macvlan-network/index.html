<!doctype html><html lang=zh-cn><head><title>Docker æ„å»ºæ‰å¹³åŒ–å®¹å™¨ç½‘ç»œ // å›´åŸ</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.85.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="å›´åŸ"><meta name=description content><link rel=stylesheet href=https://tomwei7.com/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-72226462-1','auto'),ga('send','pageview'))</script><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker æ„å»ºæ‰å¹³åŒ–å®¹å™¨ç½‘ç»œ"><meta name=twitter:description content="ğŸ’¡ ç½‘ä¸Šæœ‰å¾ˆå¤šå…³äº k8s åå¹³åŒ–ç½‘ç»œå»ºè®¾çš„æ–‡ç« ï¼Œå¤§å¤šé’ˆå¯¹äºå¤§è§„å¾‹çš„é›†ç¾¤ã€‚ä½†æ˜¯ç°åœ¨ä¹Ÿæœ‰å¾ˆå¤šäººåœ¨ NAS æˆ–è€…å®¶åº­æœåŠ¡å™¨ä¸­ä¹Ÿä¼šä½¿ç”¨ Docker éƒ¨ç½²æœåŠ¡ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿"><meta property="og:title" content="Docker æ„å»ºæ‰å¹³åŒ–å®¹å™¨ç½‘ç»œ"><meta property="og:description" content="ğŸ’¡ ç½‘ä¸Šæœ‰å¾ˆå¤šå…³äº k8s åå¹³åŒ–ç½‘ç»œå»ºè®¾çš„æ–‡ç« ï¼Œå¤§å¤šé’ˆå¯¹äºå¤§è§„å¾‹çš„é›†ç¾¤ã€‚ä½†æ˜¯ç°åœ¨ä¹Ÿæœ‰å¾ˆå¤šäººåœ¨ NAS æˆ–è€…å®¶åº­æœåŠ¡å™¨ä¸­ä¹Ÿä¼šä½¿ç”¨ Docker éƒ¨ç½²æœåŠ¡ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿"><meta property="og:type" content="article"><meta property="og:url" content="https://tomwei7.com/2022/05/03/docker-macvlan-network/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-05-03T16:16:19+08:00"><meta property="article:modified_time" content="2022-05-03T16:16:19+08:00"></head><body><header class=app-header><a href=https://tomwei7.com><img class=app-header-avatar src=/avatar.png alt=å›´åŸ></a>
<a href=https://tomwei7.com><h1>å›´åŸ</h1></a><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
-
<a class=app-header-menu-item href=/tags/>Tags</a></nav><p>ç¨‹åºå‘˜-ä»£ç -åæ§½</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Docker æ„å»ºæ‰å¹³åŒ–å®¹å™¨ç½‘ç»œ</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>May 3, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://tomwei7.com/tags/docker/>docker</a>
<a class=tag href=https://tomwei7.com/tags/network/>network</a>
<a class=tag href=https://tomwei7.com/tags/macvlan/>macvlan</a></div></div></header><div class=post-content><blockquote><blockquote><p>ğŸ’¡ ç½‘ä¸Šæœ‰å¾ˆå¤šå…³äº k8s åå¹³åŒ–ç½‘ç»œå»ºè®¾çš„æ–‡ç« ï¼Œå¤§å¤šé’ˆå¯¹äºå¤§è§„å¾‹çš„é›†ç¾¤ã€‚ä½†æ˜¯ç°åœ¨ä¹Ÿæœ‰å¾ˆå¤šäººåœ¨ NAS æˆ–è€…å®¶åº­æœåŠ¡å™¨ä¸­ä¹Ÿä¼šä½¿ç”¨ Docker éƒ¨ç½²æœåŠ¡ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨ Docker æ„å»ºæ‰å¹³åŒ–çš„ç½‘ç»œï¼Œæä¾›å®¹å™¨çš„è·¨ä¸»æœºäº’è®¿èƒ½åŠ›ã€‚</p></blockquote></blockquote><p>éšç€ 2013 å¹´ Docker çš„å‘å¸ƒï¼Œå®¹å™¨æŠ€æœ¯å¼€å§‹èµ°è¿›äº†å„å¤§äº’è”ç½‘å…¬å¸ã€‚å®¹å™¨æŠ€æœ¯ä¸ä»…ä»…æœåŠ¡äºäº’è”ç½‘å…¬å¸çš„çº¿ä¸Šä¸šåŠ¡ï¼ŒåŒæ—¶ä¹Ÿä¸ºå¼€å‘äººå‘˜æ­å»ºæµ‹è¯•ç¯å¢ƒã€ä¸‰æ–¹ä¾èµ–æœåŠ¡ç­‰æä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚é™¤äº†åœ¨ä¼ä¸šä¸­çš„åº”ç”¨ï¼Œå®¹å™¨å‡­å€Ÿç€æ— ä¾èµ–ä¸€é”®å¯åŠ¨çš„ä¼˜åŠ¿ä¹Ÿè¢«è¶Šæ¥è¶Šå¤šçš„äººç”¨äºåœ¨å®¶åº­ NAS æˆ–è€…å®¶åº­æœåŠ¡å™¨ä¸­éƒ¨ç½²æœåŠ¡ï¼ŒåŸºæœ¬ä¸Šå±äºå¿…å¤‡è½¯ä»¶ã€‚</p><p>å®¶åº­ NAS æˆ–è€…å®¶åº­æœåŠ¡å™¨ä¸­ä½¿ç”¨å®¹å™¨å¤šä½¿ç”¨ Docker æä¾›çš„ Bridge ç½‘ç»œï¼Œé€šè¿‡ç«¯å£è½¬å‘çš„æ–¹å¼å°†é€šè¿‡å®¹å™¨éƒ¨ç½²çš„æœåŠ¡æš´éœ²åˆ°å±€åŸŸç½‘ä¸­ï¼Œå…¶ä¸»è¦å®ç°æ–¹å¼å¦‚ä¸‹:</p><p><img src=docker-bridge-network.png alt=docker-bridge-network.png></p><p>å¯ä»¥ç®€å•å°† docker0 ç†è§£ä¸ºä¸€ä¸ª switchï¼Œcontainer é€šè¿‡ veth-pair è¿æ¥åˆ°è¿™ä¸ª switchï¼Œhost é€šè¿‡ docker0 è¿™ä¸ª interface è¿æ¥è¿™è¿™ä¸ª switchï¼Œcontainer å‘å‡ºçš„æ•°æ®åŒ…ç»è¿‡ host è¿›è¡Œ NAT åä»ä¸»æœºçš„ eth0 ç«¯å£æµå‡ºã€‚</p><blockquote><blockquote><p>ğŸ’¡ å¦‚æœè¿™é‡Œå°† eth0 ç›´æ¥åŠ åˆ°è¿™ä¸ª bridge ä¸­æ¥å®ç°ä¹Ÿå¯ä»¥ä½¿ç”¨åå¹³åŒ–çš„ç½‘ç»œï¼Œä½†æ˜¯ Docker æ²¡æœ‰æä¾›è¿™è¿™æ ·çš„åŠŸèƒ½ï¼Œå€Ÿç”¨ cni ä¸­çš„ bridge æ’ä»¶å®ç° <a href=https://www.cni.dev/plugins/current/main/bridge/>https://www.cni.dev/plugins/current/main/bridge/</a></p></blockquote></blockquote><p>ä½¿ç”¨ Bridge ç½‘ç»œæ—¶ç”±äºç»è¿‡äº†ä¸€å±‚ NAT è½¬å‘ï¼Œå®¹å™¨æœ‰è‡ªå·±çš„ç§æœ‰ç½‘æ®µã€‚åœ¨å…¶ä»–ä¸»æœºä¸Šè®¿é—®å®¹å™¨æœåŠ¡åªèƒ½é€šè¿‡ç«¯å£è½¬å‘çš„æ–¹å¼è®¿é—®ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•è®©å®¹å™¨åœ¨æˆ‘ä»¬çš„å±€åŸŸç½‘ä¸­ç”¨äºâ€œä¸€å¸­ä¹‹åœ°â€ï¼ˆç‹¬ç«‹IPï¼‰å‘¢ï¼Ÿå®é™…å¯è¡Œçš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹æœ€ç®€å•çš„ macvlan æ¨¡å¼</p><h3 id=macvlan>macvlan</h3><p>macvlan é¡¾åæ€ä¹‰å°±æ˜¯ä¸€ç§åŸºäº mac åœ°å€çš„åŒºåˆ† vlan çš„æ–¹å¼ã€‚æ™®é€šçš„ 802.1Q çš„ vlan é€šè¿‡åœ¨ frameï¼ˆå¸§ï¼‰ ä¸­æ·»åŠ ç‰¹å®š 802.1Q tag çš„æ–¹å¼å®ç°åœ¨å•ä¸ªç‰©ç† interface çš„åŸºç¡€ä¸Šå»ºç«‹å¤šä¸ªè™šæ‹Ÿ interfaceï¼Œé€šè¿‡ tag åŒºåˆ†å„ä¸ªæ¥å£çš„æµé‡ã€‚macvlan çš„ä¹Ÿå¯ä»¥åœ¨å•ä¸ªç‰©ç†çš„ interface ä¸Šå»ºç«‹å¤šä¸ªè™šæ‹Ÿ interface ä¸è¿‡æ˜¯é€šè¿‡ mac åœ°å€åŒºåˆ†æµé‡</p><p><img src=macvlan.drawio.png alt=macvlan.drawio.png></p><p>macvlan ä¸­çš„å­ interface ç›´æ¥çš„ç›¸äº’é€šä¿¡ï¼Œå¯ä»¥è®¾ç½®ä¸‰ç§æ¨¡å¼</p><ul><li>Private: å­ interface ä¹‹é—´ä¸å…è®¸ç›¸å…³é€šä¿¡ï¼Œå®Œå…¨éš”ç¦»</li><li>VEPA: å­ interface ä¹‹é—´çš„ç›¸äº’é€šä¿¡éœ€è¦ç”±å¤–éƒ¨äº¤æ¢æœºæˆ–è·¯ç”±å¤„ç†</li><li>Bridge: å­ interface ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œ<strong>docker ä¸­åˆ›å»ºçš„ macvlan ç½‘ç»œåªèƒ½ä½¿ç”¨ bridge æ¨¡å¼</strong></li></ul><p>è¯¦ç»†å¯ä»¥å‚è€ƒ <a href=https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#macvlan>https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#macvlan</a></p><h3 id=docker-ä¸­ä½¿ç”¨-macvlan>Docker ä¸­ä½¿ç”¨ macvlan</h3><p><strong>åˆ›å»º macvlan ç½‘ç»œ</strong></p><p>åœ¨ Docker ä¸­åˆ›å»º macvlan ååˆ†ç®€å•ï¼Œä»¥æˆ‘å½“å‰çš„ç½‘ç»œç¯å¢ƒä¸ºä¾‹åœ¨ enp3s0 interface ä¸‹åˆ›å»º macvlan ç½‘ç»œ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> enp3s0<span style=color:#f92672>:</span> &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP <span style=color:#66d9ef>group</span> default qlen <span style=color:#ae81ff>1000</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    link<span style=color:#f92672>/</span>ether a8<span style=color:#f92672>:</span>a1<span style=color:#f92672>:</span><span style=color:#ae81ff>59</span><span style=color:#f92672>:</span><span style=color:#ae81ff>24</span><span style=color:#f92672>:</span>d0<span style=color:#f92672>:</span><span style=color:#ae81ff>61</span> brd ff<span style=color:#f92672>:</span>ff<span style=color:#f92672>:</span>ff<span style=color:#f92672>:</span>ff<span style=color:#f92672>:</span>ff<span style=color:#f92672>:</span>ff<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    inet <span style=color:#ae81ff>192.168.88.9</span><span style=color:#f92672>/</span><span style=color:#ae81ff>24</span> metric <span style=color:#ae81ff>1024</span> brd <span style=color:#ae81ff>192.168.88.255</span> scope global dynamic enp3s0<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>       valid_lft <span style=color:#ae81ff>551</span>sec preferred_lft <span style=color:#ae81ff>551</span>sec<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    inet6 fe80<span style=color:#f92672>::</span>aaa1<span style=color:#f92672>:</span><span style=color:#ae81ff>59ff</span><span style=color:#f92672>:</span>fe24<span style=color:#f92672>:</span>d061<span style=color:#f92672>/</span><span style=color:#ae81ff>64</span> scope link<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>       valid_lft forever preferred_lft forever<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>enp3s0 æ‰€åœ¨çš„ç½‘æ®µä¸º 192.168.88.0/24</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf>docker network create <span style=color:#960050;background-color:#1e0010>\
</span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#f92672>-</span>d macvlan <span style=color:#960050;background-color:#1e0010>\
</span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#f92672>--</span>subnet<span style=color:#f92672>=</span><span style=color:#ae81ff>192.168.88.0</span><span style=color:#f92672>/</span><span style=color:#ae81ff>24</span> <span style=color:#960050;background-color:#1e0010>\
</span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#f92672>--</span>ip<span style=color:#f92672>-</span>range<span style=color:#f92672>=</span><span style=color:#ae81ff>192.168.88.192</span><span style=color:#f92672>/</span><span style=color:#ae81ff>27</span> <span style=color:#960050;background-color:#1e0010>\
</span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#f92672>--</span>gateway <span style=color:#ae81ff>192.168.88.1</span> <span style=color:#960050;background-color:#1e0010>\
</span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#f92672>-</span>o parent<span style=color:#f92672>=</span>enp3s0 <span style=color:#960050;background-color:#1e0010>\
</span><span style=color:#960050;background-color:#1e0010></span>	<span style=color:#f92672>--</span>aux<span style=color:#f92672>-</span>address <span style=color:#e6db74>&#39;host=192.168.88.192&#39;</span> <span style=color:#960050;background-color:#1e0010>\
</span><span style=color:#960050;background-color:#1e0010></span>	macvlan1<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p><strong>subnet</strong></p><p>å­ç½‘ç½‘æ®µï¼Œè¿™é‡Œä¸æ¥å£ç½‘æ®µä¸€è‡´å³å¯</p><p><strong>ip-range</strong></p><p>å®¹å™¨å¯ç”¨çš„ IP èŒƒå›´ ï¼Œç”±äºå®¹å™¨å¹¶ä¸ä¼šä½¿ç”¨ dhcp è·å– IP åœ°å€ï¼Œæ‰€ä»¥æŒ‡å®šçš„ ip-range åº”è¯¥ä¸è·¯ç”±å™¨ä¸­çš„ dhcp IP èŒƒå›´é”™å¼€ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œçš„ dhcp æœåŠ¡å™¨åªä¼šåˆ†é… 192.168.88.64-192.168.88.127 å…± 64 ä¸ª IPï¼Œè¿™é‡Œè®©å®¹å™¨ä½¿ç”¨ 192.168.88.192-192.168.88.192.223</p><p><strong>gateway</strong></p><p>ç½‘å…³åœ°å€ï¼Œä¸æ¥å£ç½‘æ®µä¸€è‡´å³å¯</p><p><strong>aux-address</strong></p><p>è¾…åŠ©åœ°å€ï¼Œç›¸å½“äºä¿ç•™åœ°å€ï¼Œåˆ†é…IPåœ°å€æ—¶ä¼šé¿å¼€ç›¸å…³ IP</p><p>ä½¿ç”¨ docker network ls å³å¯æŸ¥çœ‹å·²ç»åˆ›å»ºçš„ç½‘ç»œ</p><pre><code>docker network ls
NETWORK ID     NAME       DRIVER    SCOPE
fbe90109e5f2   bridge     bridge    local
9186dabfe83e   host       host      local
a373956bfe01   macvlan1   macvlan   local
47312fa573ea   none       null      local
</code></pre><p><strong>ä½¿ç”¨ macvlan åˆ›å»ºå®¹å™¨</strong></p><p>åˆ›å»ºå¥½ macvlan ç½‘ç»œåå³å¯ä½¿ç”¨ macvlan ç½‘ç»œåˆ›å»ºå®¹å™¨ï¼Œä½¿ç”¨ <code>â€”-network</code> æŒ‡å®šç½‘ç»œ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run --network macvlan1 -it --rm alpine sh
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/ <span style=color:#75715e># ip addr</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN qlen <span style=color:#ae81ff>1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
23: eth0@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noqueue state UP
    link/ether 02:42:c0:a8:58:c1 brd ff:ff:ff:ff:ff:ff
    inet 192.168.88.193/24 brd 192.168.88.255 scope global eth0
       valid_lft forever preferred_lft forever
</code></pre></div><p>è¿™æ—¶å®¹å™¨å·²ç»è·å–äº†ä¸€ä¸ªç‹¬ç«‹çš„å±€åŸŸç½‘ IPï¼Œç›¸å½“äºå±€åŸŸç½‘å†…çš„ä¸€å°ç‹¬ç«‹æœºå™¨ã€‚å¯ä»¥åœ¨å±€åŸŸç½‘å†…çš„å…¶ä»–æœºå™¨ä¸­ç›´æ¥è®¿é—®</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Î» ~ ping 192.168.88.193
PING 192.168.88.193 <span style=color:#f92672>(</span>192.168.88.193<span style=color:#f92672>)</span>: <span style=color:#ae81ff>56</span> data bytes
<span style=color:#ae81ff>64</span> bytes from 192.168.88.193: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>1.739 ms
<span style=color:#ae81ff>64</span> bytes from 192.168.88.193: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.743 ms
^C
--- 192.168.88.193 ping statistics ---
<span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>2</span> packets received, 0.0% packet loss
round-trip min/avg/max/stddev <span style=color:#f92672>=</span> 0.743/1.241/1.739/0.498 ms
</code></pre></div><p><strong>ä½†æ˜¯è¿™æ—¶å¹¶æ²¡æœ‰åŠæ³•åœ¨å½“å‰å®¿ä¸»æœºï¼ˆå³å®¹å™¨æ‰€åœ¨çš„æœºå™¨ï¼‰ä¸Šè®¿é—®å®¹å™¨</strong>ï¼Œè¿™æ˜¯å› ä¸ºå®¿ä¸»æœºä¸Šå‘å‡ºçš„æ•°æ®åŒ…ä¼šç›´æ¥ç»è¿‡ç‰©ç†æ¥å£ enp3s0 æµå‡ºè€Œä¸ä¼šè¿›è¡Œ macvlan å†…éƒ¨çš„ bridgeï¼Œåˆ°è¾¾å¤–éƒ¨ç½‘ç»œè®¾å¤‡åé™¤éå¤–éƒ¨çš„äº¤æ¢æœºæˆ–è€…è·¯ç”±å™¨æ”¯æŒ <a href=https://en.wikipedia.org/wiki/Hairpinning>hairpin mode</a> å¦åˆ™æ— æ³•è¿›è¡Œè®¿é—®ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™å®¿ä¸»æœºæ·»åŠ ä¸€ä¸ª macvlan çš„ interface ç”¨äºè®¿é—®å®¹å™¨</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># åˆ›å»ºä¸€ä¸ª bridge æ¨¡å¼çš„ macvlan interface docker-link</span>
ip link add docker-link link enp3s0 type macvlan mode bridge
<span style=color:#75715e># è®¾ç½® docker-link åœ°å€ï¼Œä½¿ç”¨ aux-address ä¸­ä¿ç•™çš„ IP åœ°å€</span>
ip addr add 192.168.88.192/27 brd + dev docker-link
<span style=color:#75715e># å¯ç”¨ docker-link æ¥å£</span>
ip link set docker-link up
<span style=color:#75715e># æ·»åŠ è·¯ç”± å°† 192.168.88.192/27 ç½‘æ®µæµé‡æŒ‡å‘ docker-link æ¥å£</span>
ip route add 192.168.88.192/27 dev docker-link
</code></pre></div><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åœ¨å®¿ä¸»æœºä¸­é¡ºåˆ©è®¿é—®å®¹å™¨</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tomwei7@my-lab-a300 Î» ~ ping 192.168.88.193
PING 192.168.88.193 <span style=color:#f92672>(</span>192.168.88.193<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
<span style=color:#ae81ff>64</span> bytes from 192.168.88.193: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.038 ms
<span style=color:#ae81ff>64</span> bytes from 192.168.88.193: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.070 ms
^C
--- 192.168.88.193 ping statistics ---
<span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>2</span> received, 0% packet loss, time 1005ms
rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.038/0.054/0.070/0.016 ms
</code></pre></div><h3 id=macvlan-é…åˆ-8021q-vlan>macvlan é…åˆ 802.1q VLAN</h3><p>macvlan çš„çˆ¶æ¥å£ä¸ä¸€å®šè¦æ˜¯ç‰©ç†æ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯ vlan æ¥å£ï¼Œè¿™é‡Œ Docker åšäº†ä¸€ç‚¹ç‚¹è¯­æ³•ç³–å¦‚æœçˆ¶æ¥å£ä¸­åŒ…å« . åˆ™ä¼šåˆ›å»ºå¯¹åº”çš„ vlan æ¥å£ï¼Œä¾‹å¦‚åˆ›å»ºå¦‚ä¸‹ macvlan ç½‘ç»œï¼Œ</p><ul><li>vlan id 200</li><li>ç½‘æ®µ 192.168.200.0/24</li><li>ç½‘å…³ 192.168.200.1</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker network create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-d macvlan <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	--subnet<span style=color:#f92672>=</span>192.168.200.0/24 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	--ip-range<span style=color:#f92672>=</span>192.168.200.0/24 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	--gateway 192.168.200.1 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	-o parent<span style=color:#f92672>=</span>enp3s0.200 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	macvlan2
</code></pre></div><p>docker ä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„ vlan interface</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ip -details link show

26: enp3s0.200@enp3s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noqueue state UP mode DEFAULT group default
    link/ether a8:a1:59:24:d0:61 brd ff:ff:ff:ff:ff:ff promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>0</span> maxmtu <span style=color:#ae81ff>65535</span>
    vlan protocol 802.1Q id <span style=color:#ae81ff>200</span> &lt;REORDER_HDR&gt; addrgenmode eui64 numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>64000</span> gso_max_segs <span style=color:#ae81ff>64</span>
</code></pre></div><p>ä½¿ç”¨ vlan è¿˜éœ€è¦åœ¨è·¯ç”±å™¨ä¸­è¿›è¡Œå¯¹åº”çš„é…ç½®ä»¥åŠé˜²ç«å¢™è§„åˆ™ï¼Œ</p><p>ä»¥å½“å‰ç½‘ç»œä½¿ç”¨çš„ RouterOS ä¸ºä¾‹éœ€è¦æ·»åŠ  vlan interface ä»¥åŠä¸ºå¯¹åº” interface è®¾ç½® IP</p><pre><code># main-bridge ä¸ºå½“å‰æœºå™¨è¿æ¥çš„æ¥å£æ‰€åœ¨ bridge ä¹Ÿå¯ä»¥ç›´æ¥è®¾ç½®åœ¨ç«¯å£ä¸Š
/interface/vlan/add interface=main-bridge vlan-id=200 name=vlan-200-docker-demo
/ip/address/add address=192.168.200.1/24 interface=vlan-200-docker-demo
</code></pre><p>å¯èƒ½å¤§éƒ¨åˆ†äººçš„è·¯ç”±å™¨ç³»ç»Ÿæ˜¯ openwrtï¼Œopenwrt ç¯å¢ƒä¸‹åˆ™å¯ä»¥ç›´æ¥é€šè¿‡ UI æ“ä½œï¼Œåœ¨ Network / interface ä¸‹æ·»åŠ æ–°çš„ interfaceã€‚protocol é€‰æ‹© static addressï¼Œdevice é€‰æ‹© custom device åç§°æ ¼å¼ä¸º interface.vlanid æ¯”å¦‚è¿™é‡Œä½¿ç”¨ br-lan æ¥å£ vlan ä¸º 200 åˆ™ device åç§°ä¸º br-lan.200</p><p><img src=openwrt-vlan-01.png alt=openwrt-vlan-01.png></p><p>éšåä¸º interface è®¾ç½® IP å³å¯</p><p><img src=openwrt-vlan-02.png alt=openwrt-vlan-02.png></p><blockquote><blockquote><p>ğŸ’¡ å¦‚æœä¸»æœºä¸æ˜¯ç›´æ¥è¿æ¥åˆ°è·¯ç”±å™¨è¿˜å­˜åœ¨äº¤æ¢æœºç­‰è¿˜éœ€è¦è¿›è¡Œå¯¹åº”ç­‰ vlan è®¾ç½®è¿™é‡Œä¸åšèµ˜è¿°</p></blockquote></blockquote><h3 id=å…¶ä»–>å…¶ä»–</h3><p>ä¸Šæ–‡ä¸»è¦æ˜¯ä»¥ docker ä¸ºä¾‹ï¼Œå…¶ä»–ä¾‹å¦‚ podman ä¹Ÿå¯ä»¥ç±»ä¼¼çš„åŠŸèƒ½ã€‚æ‰å¹³åŒ–çš„å®¹å™¨ç½‘ç»œå¯ä»¥è®©æˆ‘ä»¬çš„å®¹å™¨åœ¨å±€åŸŸç½‘ä¸­æ‹¥æœ‰â€œå§“åâ€ (IP)ï¼Œç›¸è¾ƒäº bridge ç½‘ç»œä¸éœ€è¦è€ƒè™‘ç«¯å£å¤Ÿä¸å¤Ÿç”¨ã€åº”è¯¥æš´éœ²é‚£äº›ç«¯å£ç­‰ç­‰é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿèƒ½è®©å®¿ä¸»æœºçš„ iptables æ¸…çˆ½å¾ˆå¤šã€‚</p></div><div class=post-footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//tomwei7.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></main></body></html>