<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="由于同事了调岗，接手了一个简单的缩略图服务，大佬看之前的代码过于混(la)乱(ji)大手一挥带着我们用 C++ 重构了这个服务，故事就发生在新服务上"><title>记一次 ImageMagick jpeg 缩放性能调优</title><link rel=canonical href=http://example.org/2020/10/11/imagemagick-tuning.html><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="记一次 ImageMagick jpeg 缩放性能调优"><meta property="og:description" content="由于同事了调岗，接手了一个简单的缩略图服务，大佬看之前的代码过于混(la)乱(ji)大手一挥带着我们用 C++ 重构了这个服务，故事就发生在新服务上"><meta property="og:url" content="http://example.org/2020/10/11/imagemagick-tuning.html"><meta property="og:site_name" content="围城"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="ImageMagick"><meta property="article:tag" content="jpeg"><meta property="article:published_time" content="2020-10-11T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-11T00:00:00+00:00"><meta property="og:image" content="http://example.org/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg"><meta name=twitter:title content="记一次 ImageMagick jpeg 缩放性能调优"><meta name=twitter:description content="由于同事了调岗，接手了一个简单的缩略图服务，大佬看之前的代码过于混(la)乱(ji)大手一挥带着我们用 C++ 重构了这个服务，故事就发生在新服务上"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://example.org/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg"><link rel="shortcut icon" href=/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-72226462-1','auto'),ga('send','pageview'))</script></head><body class="article-page has-toc"><script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/2020/10/11/imagemagick-tuning.html><img src=/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_800x0_resize_q75_box.jpg srcset="/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_800x0_resize_q75_box.jpg 800w, /2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_1600x0_resize_q75_box.jpg 1600w" width=800 height=576 loading=lazy alt="Featured image of post 记一次 ImageMagick jpeg 缩放性能调优"></a></div><div class=article-details><header class=article-category><a href=/categories/imagemagick.html>ImageMagick</a></header><h2 class=article-title><a href=/2020/10/11/imagemagick-tuning.html>记一次 ImageMagick jpeg 缩放性能调优</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Oct 11, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 4 分钟</time></div></footer></div></header><section class=article-content><p>由于同事了调岗，接手了一个简单的缩略图服务，大佬看之前的代码过于混(la)乱(ji)大手一挥带着我们用 C++ 重构了这个服务，故事就发生在新服务上线几周后。在一个愉快的周五下班后，正在桌上吃着火锅突然收到告警服务开始超时，赶紧联系同事重启了一波，但是效果甚微。无奈紧急切回来旧服务。</p><p>事后进行分析发现是因为有一张非常高分辨率的图片导致的，由于上传时只限制了用户上传的图片体积大小没有检查图片实际分辨率再加上上游服务的不合理重试，几乎让这张图片占满了所有的工作线程，最终导致雪崩。</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg data-size=1000x720><img src=/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg width=1000 height=720 srcset="/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_480x0_resize_q75_box.jpg 480w, /2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt=罪魁祸首.jpeg></a><figcaption>罪魁祸首.jpeg</figcaption></figure></p><p>由于图片太大上面的是缩略图，感兴趣的可以点击这里下载原图<a class=link href=df35a6b35caea63c4be3c19947407fe4426a2b3c.jpeg>罪魁祸首.jpeg</a>, 原图的大小大小约 24000x17280 总像素超过4亿</p><h3 id=问题重现>问题重现</h3><p>竟然知道了问题是超高分辨率，就需要看看有没有可以优化的地方。图片处理我们主要使用的是 ImageMagick 这个开源库，首先将服务最小化，缩略图的主要逻辑大概就这几行</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>Magick<span style=color:#f92672>::</span>Image im;
im.read(<span style=color:#e6db74>&#34;big-img.jpeg&#34;</span>);
im.filterType(Magick<span style=color:#f92672>::</span>LanczosFilter);
im.resize(Magick<span style=color:#f92672>::</span>Geometry(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>288</span>));
im.write(<span style=color:#e6db74>&#34;thumbnail.jpeg&#34;</span>);
</code></pre></div><p>首先用出问题的图片跑一下试试 (因为一些资源管理问题，ImageMagick 在这里没有开启 openmp，都是单线程工作的)</p><pre><code>User time (seconds): 9.71
System time (seconds): 0.96
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4954472
</code></pre><p>在我自己电脑上大约需要 10s 占用约 4G 内存，实际在公司服务器大约需要 15s 左右 (AMD Yes!)，对于一个在线服务很明显是不能接受的。通过 perf 工具可以看出，CPU 主要都是花在 resize 的过程中。</p><p>调整 filterType 可以起到优化的左右，比如将但是调整 filterType 到 PointFilter，处理时间一下子就可以来到 1.4s 内存占用还是 4G，但是图片效果基本就不能接受了</p><pre><code>User time (seconds): 1.40
System time (seconds): 0.91
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4953288
</code></pre><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/pointfilter-1.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/pointfilter-1.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/pointfilter-1_huf2e2f9a75bb0d59f349533868ace8fb9_57903_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/pointfilter-1_huf2e2f9a75bb0d59f349533868ace8fb9_57903_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=pointfilter-1.jpeg></a><figcaption>pointfilter-1.jpeg</figcaption></figure></p><p>而且修改 filterType 可能会导致其他图片最终呈现的效果与约定的不一致，所以 filterType 基本上是不能修改的。</p><h3 id=从-imagemagick-入手>从 ImageMagick 入手</h3><p>为了解决这个问题我又去翻了一下 ImageMagick 的文档与代码，看看是不是已经有对这种超高分辨率的图片做缩略图的优化了，毕竟这个是很常见的需求。果然 ImageMagick 除了 <code>resize</code> 还提供了一个 <code>thumbnail</code> 的方法，<code>thumbnail</code> 顾名思义就是用来生成缩略图的，翻了一下代码 <code>thumbnail</code> 主要分为两个过程</p><ol><li>对原图进行简单采样及每隔 5 个像素点取一个，等于将原图长宽都缩小到以前的五分之一</li><li>进行普通 <code>resize</code> 操作</li></ol><p>因为第一步的采样过程非常暴力，所有只有到缩略图的大小是原图面积的 10% 以下而且原图的长宽都需要大于25像素，否则都会降级为普通的 <code>resize</code> 操作</p><p>简单修改下代码进行测试</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>Magick<span style=color:#f92672>::</span>Image im;
im.read(<span style=color:#e6db74>&#34;big-img.jpeg&#34;</span>);
im.filterType(Magick<span style=color:#f92672>::</span>LanczosFilter);
im.thumbnail(Magick<span style=color:#f92672>::</span>Geometry(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>288</span>));
im.write(<span style=color:#e6db74>&#34;thumbnail.jpeg&#34;</span>);
</code></pre></div><p>改用 <code>thumbnail</code> 耗时一下子降到到 1.4s 左右，基本和使用 PointFilter 性能差不多，而且最终输出的图片与直接进行 <code>resize</code> 的结果从肉眼上基本没有差距，但是仍然会占用约 4G 左右的内存。</p><pre><code>User time (seconds): 1.44
System time (seconds): 0.90
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4912756
</code></pre><p>使用 <code>thumbnail</code> 结果</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/thumbnail-1.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/thumbnail-1.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/thumbnail-1_hue3986c2b13178fba7736002e4ff90722_49247_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/thumbnail-1_hue3986c2b13178fba7736002e4ff90722_49247_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=thumbnail-1.jpeg></a><figcaption>thumbnail-1.jpeg</figcaption></figure></p><p>直接 <code>resize</code> 结果</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/direct-resize.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/direct-resize.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/direct-resize_hu2c71c5a01e1e6cc3ad72b664c024de70_49150_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/direct-resize_hu2c71c5a01e1e6cc3ad72b664c024de70_49150_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=direct-resize.jpeg></a><figcaption>direct-resize.jpeg</figcaption></figure></p><h3 id=从-jpeg-格式入手>从 jpeg 格式入手</h3><p>虽然使用了 <code>thumbnail</code> 可以解决耗时问题，但是一次处理要占用 4G 多内存还是不可接受的。要避免占用这么多内存就要避免一次把所有像素都放到内存里面，一般会想到的就是通过流式的方式处理数据，这样就能大大降低内存占用了，另一个开源的图片处理库<a class=link href=https://github.com/libvips/libvips target=_blank rel=noopener>libvips</a> 就是这样做的，但是将 ImageMagick 改造成流式处理的话这个工作量就过大了。对于 jpeg 这种图片格式还有另外一种方式就是可以在解压像素的时候做到类似缩放的功能，这里就要牵扯到 jpeg 的工作原理了，jpeg 的压缩算法基于<a class=link href=https://zh.wikipedia.org/wiki/%E7%A6%BB%E6%95%A3%E4%BD%99%E5%BC%A6%E5%8F%98%E6%8D%A2 target=_blank rel=noopener>离散余弦变换</a>，这里打个比方可以理解为 jpeg 将像素存储在一个函数中，当解压的时候输入像素的下标就能获得这个像素原始的数据，比如对于一个 1000x1000 的图片，我希望在解压成一张 500*500 图片，那样在解压时我只要跳过那些我不需要的像素点就好了，当时实际情况更加复杂，jpeg 也不是存储在一个函数中的。这里推荐一个很好的介绍 jpeg 工作原理的视频 <a class=link href="https://www.youtube.com/watch?v=f2odrCGjOFY" target=_blank rel=noopener>How JPEG works</a></p><p>有了这样的理论基础我们就可以实践了，其实 <code>libjpeg</code> 已经提供了这个参数，可以再解压 jpeg 的时候指定缩放的比例，比例有固定的档位在 1~8 之间，也就是说最小只能缩放到原图的长宽的八分之一。 在 ImageMagick 中设置这个参数的方式有点诡异，代码如下，这里指定 <code>jpeg:size</code> 其实只是指定了一个期望值实际获得的图片大小会是一个大于目标尺寸的最小值，比如这次测试的图片实际获得的图片大小是 3000x2160。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>Magick<span style=color:#f92672>::</span>Image im;
MagickCore<span style=color:#f92672>::</span>ImageInfo<span style=color:#f92672>*</span> im_info <span style=color:#f92672>=</span> im.imageInfo();
im_info<span style=color:#f92672>-&gt;</span>options <span style=color:#f92672>=</span> MagickCore<span style=color:#f92672>::</span>NewSplayTree(MagickCore<span style=color:#f92672>::</span>CompareSplayTreeString, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)) <span style=color:#66d9ef>nullptr</span>, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)) <span style=color:#66d9ef>nullptr</span>);
MagickCore<span style=color:#f92672>::</span>AddValueToSplayTree((MagickCore<span style=color:#f92672>::</span>SplayTreeInfo<span style=color:#f92672>*</span>)(im_info<span style=color:#f92672>-&gt;</span>options), <span style=color:#e6db74>&#34;jpeg:size&#34;</span>, <span style=color:#e6db74>&#34;400x288&#34;</span>);
im.read(<span style=color:#e6db74>&#34;big-img.jpeg&#34;</span>);
im.filterType(Magick<span style=color:#f92672>::</span>LanczosFilter);
im.resize(Magick<span style=color:#f92672>::</span>Geometry(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>288</span>));
im.write(<span style=color:#e6db74>&#34;shrink-on-load.jpeg&#34;</span>);
</code></pre></div><p>优化之后耗时降低到了 0.4s 左右，内存也降到了 100M！ 而且最终输出的结果与直接进行 <code>resize</code> 的结果从肉眼上基本没有差距</p><pre><code>User time (seconds): 0.42
System time (seconds): 0.02
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 104656
</code></pre><p>解压时缩放结果</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=shrink-on-load.jpeg></a><figcaption>shrink-on-load.jpeg</figcaption></figure></p><p>直接 <code>resize</code> 结果</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=shrink-on-load.jpeg></a><figcaption>shrink-on-load.jpeg</figcaption></figure></p><h3 id=题外话>题外话</h3><p>因为 ImageMagick 不支持 SIMD 加速在测试的过程我也尝试过使用支持 SIMD 加速的图片库比如 <a class=link href=https://github.com/uploadcare/pillow-simd target=_blank rel=noopener>pillow-simd</a> 处理完整分辨率的图像也基本能控制在 1s 级别，不能利用现代 CPU 的功能是 ImageMagick 的硬伤</p><h3 id=总结>总结</h3><p>这次缩略图的优化，对于这种超大分辨率的图片处理速度提升了一个数量级 (10s -> 0.5s) 同时内存占用也降到了一个数量级 (4G -> 100M)。基本上达到了在线服务的能力。这个故事告诉我们没事别去重构老服务😅</p><h3 id=参考>参考</h3><ul><li><a class=link href=http://www.imagemagick.org/Usage/thumbnails/ target=_blank rel=noopener>Imagemagick thumbnails/</a></li><li><a class=link href=https://libjpeg-turbo.org/ target=_blank rel=noopener>libjpeg-turbo.org/</a></li><li><a class=link href=https://stackoverflow.com/questions/42022982/imagemagick-single-convert-command-performance target=_blank rel=noopener>Imagemagick Single Convert Command Performance</a></li><li><a class=link href="https://www.youtube.com/watch?v=f2odrCGjOFY" target=_blank rel=noopener>How JPEG works</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/imagemagick.html>ImageMagick</a>
<a href=/tags/jpeg.html>jpeg</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//tomwei7.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2016 -
2021 围城</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ul><li><ul><li><a href=#问题重现>问题重现</a></li><li><a href=#从-imagemagick-入手>从 ImageMagick 入手</a></li><li><a href=#从-jpeg-格式入手>从 jpeg 格式入手</a></li><li><a href=#题外话>题外话</a></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script></body></html>