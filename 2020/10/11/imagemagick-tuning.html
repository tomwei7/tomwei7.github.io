<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ç”±äºåŒäº‹äº†è°ƒå²—ï¼Œæ¥æ‰‹äº†ä¸€ä¸ªç®€å•çš„ç¼©ç•¥å›¾æœåŠ¡ï¼Œå¤§ä½¬çœ‹ä¹‹å‰çš„ä»£ç è¿‡äºæ··(la)ä¹±(ji)å¤§æ‰‹ä¸€æŒ¥å¸¦ç€æˆ‘ä»¬ç”¨ C++ é‡æ„äº†è¿™ä¸ªæœåŠ¡ï¼Œæ•…äº‹å°±å‘ç”Ÿåœ¨æ–°æœåŠ¡ä¸Š"><title>è®°ä¸€æ¬¡ ImageMagick jpeg ç¼©æ”¾æ€§èƒ½è°ƒä¼˜</title><link rel=canonical href=http://example.org/2020/10/11/imagemagick-tuning.html><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="è®°ä¸€æ¬¡ ImageMagick jpeg ç¼©æ”¾æ€§èƒ½è°ƒä¼˜"><meta property="og:description" content="ç”±äºåŒäº‹äº†è°ƒå²—ï¼Œæ¥æ‰‹äº†ä¸€ä¸ªç®€å•çš„ç¼©ç•¥å›¾æœåŠ¡ï¼Œå¤§ä½¬çœ‹ä¹‹å‰çš„ä»£ç è¿‡äºæ··(la)ä¹±(ji)å¤§æ‰‹ä¸€æŒ¥å¸¦ç€æˆ‘ä»¬ç”¨ C++ é‡æ„äº†è¿™ä¸ªæœåŠ¡ï¼Œæ•…äº‹å°±å‘ç”Ÿåœ¨æ–°æœåŠ¡ä¸Š"><meta property="og:url" content="http://example.org/2020/10/11/imagemagick-tuning.html"><meta property="og:site_name" content="å›´åŸ"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="ImageMagick"><meta property="article:tag" content="jpeg"><meta property="article:published_time" content="2020-10-11T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-11T00:00:00+00:00"><meta property="og:image" content="http://example.org/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg"><meta name=twitter:title content="è®°ä¸€æ¬¡ ImageMagick jpeg ç¼©æ”¾æ€§èƒ½è°ƒä¼˜"><meta name=twitter:description content="ç”±äºåŒäº‹äº†è°ƒå²—ï¼Œæ¥æ‰‹äº†ä¸€ä¸ªç®€å•çš„ç¼©ç•¥å›¾æœåŠ¡ï¼Œå¤§ä½¬çœ‹ä¹‹å‰çš„ä»£ç è¿‡äºæ··(la)ä¹±(ji)å¤§æ‰‹ä¸€æŒ¥å¸¦ç€æˆ‘ä»¬ç”¨ C++ é‡æ„äº†è¿™ä¸ªæœåŠ¡ï¼Œæ•…äº‹å°±å‘ç”Ÿåœ¨æ–°æœåŠ¡ä¸Š"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://example.org/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg"><link rel="shortcut icon" href=/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-72226462-1','auto'),ga('send','pageview'))</script></head><body class="article-page has-toc"><script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>è¿”å›</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/2020/10/11/imagemagick-tuning.html><img src=/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_800x0_resize_q75_box.jpg srcset="/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_800x0_resize_q75_box.jpg 800w, /2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_1600x0_resize_q75_box.jpg 1600w" width=800 height=576 loading=lazy alt="Featured image of post è®°ä¸€æ¬¡ ImageMagick jpeg ç¼©æ”¾æ€§èƒ½è°ƒä¼˜"></a></div><div class=article-details><header class=article-category><a href=/categories/imagemagick.html>ImageMagick</a></header><h2 class=article-title><a href=/2020/10/11/imagemagick-tuning.html>è®°ä¸€æ¬¡ ImageMagick jpeg ç¼©æ”¾æ€§èƒ½è°ƒä¼˜</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Oct 11, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 4 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p>ç”±äºåŒäº‹äº†è°ƒå²—ï¼Œæ¥æ‰‹äº†ä¸€ä¸ªç®€å•çš„ç¼©ç•¥å›¾æœåŠ¡ï¼Œå¤§ä½¬çœ‹ä¹‹å‰çš„ä»£ç è¿‡äºæ··(la)ä¹±(ji)å¤§æ‰‹ä¸€æŒ¥å¸¦ç€æˆ‘ä»¬ç”¨ C++ é‡æ„äº†è¿™ä¸ªæœåŠ¡ï¼Œæ•…äº‹å°±å‘ç”Ÿåœ¨æ–°æœåŠ¡ä¸Šçº¿å‡ å‘¨åã€‚åœ¨ä¸€ä¸ªæ„‰å¿«çš„å‘¨äº”ä¸‹ç­åï¼Œæ­£åœ¨æ¡Œä¸Šåƒç€ç«é”…çªç„¶æ”¶åˆ°å‘Šè­¦æœåŠ¡å¼€å§‹è¶…æ—¶ï¼Œèµ¶ç´§è”ç³»åŒäº‹é‡å¯äº†ä¸€æ³¢ï¼Œä½†æ˜¯æ•ˆæœç”šå¾®ã€‚æ— å¥ˆç´§æ€¥åˆ‡å›æ¥æ—§æœåŠ¡ã€‚</p><p>äº‹åè¿›è¡Œåˆ†æå‘ç°æ˜¯å› ä¸ºæœ‰ä¸€å¼ éå¸¸é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡å¯¼è‡´çš„ï¼Œç”±äºä¸Šä¼ æ—¶åªé™åˆ¶äº†ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ä½“ç§¯å¤§å°æ²¡æœ‰æ£€æŸ¥å›¾ç‰‡å®é™…åˆ†è¾¨ç‡å†åŠ ä¸Šä¸Šæ¸¸æœåŠ¡çš„ä¸åˆç†é‡è¯•ï¼Œå‡ ä¹è®©è¿™å¼ å›¾ç‰‡å æ»¡äº†æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œæœ€ç»ˆå¯¼è‡´é›ªå´©ã€‚</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg data-size=1000x720><img src=/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small.jpg width=1000 height=720 srcset="/2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_480x0_resize_q75_box.jpg 480w, /2020/10/11/imagemagick-tuning/df35a6b35caea63c4be3c19947407fe4426a2b3c-small_hu2fc75db2453bb048d467a4727f6ed77a_213366_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt=ç½ªé­ç¥¸é¦–.jpeg></a><figcaption>ç½ªé­ç¥¸é¦–.jpeg</figcaption></figure></p><p>ç”±äºå›¾ç‰‡å¤ªå¤§ä¸Šé¢çš„æ˜¯ç¼©ç•¥å›¾ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç‚¹å‡»è¿™é‡Œä¸‹è½½åŸå›¾<a class=link href=df35a6b35caea63c4be3c19947407fe4426a2b3c.jpeg>ç½ªé­ç¥¸é¦–.jpeg</a>, åŸå›¾çš„å¤§å°å¤§å°çº¦ 24000x17280 æ€»åƒç´ è¶…è¿‡4äº¿</p><h3 id=é—®é¢˜é‡ç°>é—®é¢˜é‡ç°</h3><p>ç«Ÿç„¶çŸ¥é“äº†é—®é¢˜æ˜¯è¶…é«˜åˆ†è¾¨ç‡ï¼Œå°±éœ€è¦çœ‹çœ‹æœ‰æ²¡æœ‰å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ã€‚å›¾ç‰‡å¤„ç†æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„æ˜¯ ImageMagick è¿™ä¸ªå¼€æºåº“ï¼Œé¦–å…ˆå°†æœåŠ¡æœ€å°åŒ–ï¼Œç¼©ç•¥å›¾çš„ä¸»è¦é€»è¾‘å¤§æ¦‚å°±è¿™å‡ è¡Œ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>Magick<span style=color:#f92672>::</span>Image im;
im.read(<span style=color:#e6db74>&#34;big-img.jpeg&#34;</span>);
im.filterType(Magick<span style=color:#f92672>::</span>LanczosFilter);
im.resize(Magick<span style=color:#f92672>::</span>Geometry(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>288</span>));
im.write(<span style=color:#e6db74>&#34;thumbnail.jpeg&#34;</span>);
</code></pre></div><p>é¦–å…ˆç”¨å‡ºé—®é¢˜çš„å›¾ç‰‡è·‘ä¸€ä¸‹è¯•è¯• (å› ä¸ºä¸€äº›èµ„æºç®¡ç†é—®é¢˜ï¼ŒImageMagick åœ¨è¿™é‡Œæ²¡æœ‰å¼€å¯ openmpï¼Œéƒ½æ˜¯å•çº¿ç¨‹å·¥ä½œçš„)</p><pre><code>User time (seconds): 9.71
System time (seconds): 0.96
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4954472
</code></pre><p>åœ¨æˆ‘è‡ªå·±ç”µè„‘ä¸Šå¤§çº¦éœ€è¦ 10s å ç”¨çº¦ 4G å†…å­˜ï¼Œå®é™…åœ¨å…¬å¸æœåŠ¡å™¨å¤§çº¦éœ€è¦ 15s å·¦å³ (AMD Yes!)ï¼Œå¯¹äºä¸€ä¸ªåœ¨çº¿æœåŠ¡å¾ˆæ˜æ˜¾æ˜¯ä¸èƒ½æ¥å—çš„ã€‚é€šè¿‡ perf å·¥å…·å¯ä»¥çœ‹å‡ºï¼ŒCPU ä¸»è¦éƒ½æ˜¯èŠ±åœ¨ resize çš„è¿‡ç¨‹ä¸­ã€‚</p><p>è°ƒæ•´ filterType å¯ä»¥èµ·åˆ°ä¼˜åŒ–çš„å·¦å³ï¼Œæ¯”å¦‚å°†ä½†æ˜¯è°ƒæ•´ filterType åˆ° PointFilterï¼Œå¤„ç†æ—¶é—´ä¸€ä¸‹å­å°±å¯ä»¥æ¥åˆ° 1.4s å†…å­˜å ç”¨è¿˜æ˜¯ 4Gï¼Œä½†æ˜¯å›¾ç‰‡æ•ˆæœåŸºæœ¬å°±ä¸èƒ½æ¥å—äº†</p><pre><code>User time (seconds): 1.40
System time (seconds): 0.91
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4953288
</code></pre><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/pointfilter-1.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/pointfilter-1.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/pointfilter-1_huf2e2f9a75bb0d59f349533868ace8fb9_57903_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/pointfilter-1_huf2e2f9a75bb0d59f349533868ace8fb9_57903_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=pointfilter-1.jpeg></a><figcaption>pointfilter-1.jpeg</figcaption></figure></p><p>è€Œä¸”ä¿®æ”¹ filterType å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–å›¾ç‰‡æœ€ç»ˆå‘ˆç°çš„æ•ˆæœä¸çº¦å®šçš„ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ filterType åŸºæœ¬ä¸Šæ˜¯ä¸èƒ½ä¿®æ”¹çš„ã€‚</p><h3 id=ä»-imagemagick-å…¥æ‰‹>ä» ImageMagick å…¥æ‰‹</h3><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘åˆå»ç¿»äº†ä¸€ä¸‹ ImageMagick çš„æ–‡æ¡£ä¸ä»£ç ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å·²ç»æœ‰å¯¹è¿™ç§è¶…é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡åšç¼©ç•¥å›¾çš„ä¼˜åŒ–äº†ï¼Œæ¯•ç«Ÿè¿™ä¸ªæ˜¯å¾ˆå¸¸è§çš„éœ€æ±‚ã€‚æœç„¶ ImageMagick é™¤äº† <code>resize</code> è¿˜æä¾›äº†ä¸€ä¸ª <code>thumbnail</code> çš„æ–¹æ³•ï¼Œ<code>thumbnail</code> é¡¾åæ€ä¹‰å°±æ˜¯ç”¨æ¥ç”Ÿæˆç¼©ç•¥å›¾çš„ï¼Œç¿»äº†ä¸€ä¸‹ä»£ç  <code>thumbnail</code> ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹</p><ol><li>å¯¹åŸå›¾è¿›è¡Œç®€å•é‡‡æ ·åŠæ¯éš” 5 ä¸ªåƒç´ ç‚¹å–ä¸€ä¸ªï¼Œç­‰äºå°†åŸå›¾é•¿å®½éƒ½ç¼©å°åˆ°ä»¥å‰çš„äº”åˆ†ä¹‹ä¸€</li><li>è¿›è¡Œæ™®é€š <code>resize</code> æ“ä½œ</li></ol><p>å› ä¸ºç¬¬ä¸€æ­¥çš„é‡‡æ ·è¿‡ç¨‹éå¸¸æš´åŠ›ï¼Œæ‰€æœ‰åªæœ‰åˆ°ç¼©ç•¥å›¾çš„å¤§å°æ˜¯åŸå›¾é¢ç§¯çš„ 10% ä»¥ä¸‹è€Œä¸”åŸå›¾çš„é•¿å®½éƒ½éœ€è¦å¤§äº25åƒç´ ï¼Œå¦åˆ™éƒ½ä¼šé™çº§ä¸ºæ™®é€šçš„ <code>resize</code> æ“ä½œ</p><p>ç®€å•ä¿®æ”¹ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>Magick<span style=color:#f92672>::</span>Image im;
im.read(<span style=color:#e6db74>&#34;big-img.jpeg&#34;</span>);
im.filterType(Magick<span style=color:#f92672>::</span>LanczosFilter);
im.thumbnail(Magick<span style=color:#f92672>::</span>Geometry(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>288</span>));
im.write(<span style=color:#e6db74>&#34;thumbnail.jpeg&#34;</span>);
</code></pre></div><p>æ”¹ç”¨ <code>thumbnail</code> è€—æ—¶ä¸€ä¸‹å­é™åˆ°åˆ° 1.4s å·¦å³ï¼ŒåŸºæœ¬å’Œä½¿ç”¨ PointFilter æ€§èƒ½å·®ä¸å¤šï¼Œè€Œä¸”æœ€ç»ˆè¾“å‡ºçš„å›¾ç‰‡ä¸ç›´æ¥è¿›è¡Œ <code>resize</code> çš„ç»“æœä»è‚‰çœ¼ä¸ŠåŸºæœ¬æ²¡æœ‰å·®è·ï¼Œä½†æ˜¯ä»ç„¶ä¼šå ç”¨çº¦ 4G å·¦å³çš„å†…å­˜ã€‚</p><pre><code>User time (seconds): 1.44
System time (seconds): 0.90
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 4912756
</code></pre><p>ä½¿ç”¨ <code>thumbnail</code> ç»“æœ</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/thumbnail-1.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/thumbnail-1.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/thumbnail-1_hue3986c2b13178fba7736002e4ff90722_49247_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/thumbnail-1_hue3986c2b13178fba7736002e4ff90722_49247_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=thumbnail-1.jpeg></a><figcaption>thumbnail-1.jpeg</figcaption></figure></p><p>ç›´æ¥ <code>resize</code> ç»“æœ</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/direct-resize.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/direct-resize.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/direct-resize_hu2c71c5a01e1e6cc3ad72b664c024de70_49150_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/direct-resize_hu2c71c5a01e1e6cc3ad72b664c024de70_49150_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=direct-resize.jpeg></a><figcaption>direct-resize.jpeg</figcaption></figure></p><h3 id=ä»-jpeg-æ ¼å¼å…¥æ‰‹>ä» jpeg æ ¼å¼å…¥æ‰‹</h3><p>è™½ç„¶ä½¿ç”¨äº† <code>thumbnail</code> å¯ä»¥è§£å†³è€—æ—¶é—®é¢˜ï¼Œä½†æ˜¯ä¸€æ¬¡å¤„ç†è¦å ç”¨ 4G å¤šå†…å­˜è¿˜æ˜¯ä¸å¯æ¥å—çš„ã€‚è¦é¿å…å ç”¨è¿™ä¹ˆå¤šå†…å­˜å°±è¦é¿å…ä¸€æ¬¡æŠŠæ‰€æœ‰åƒç´ éƒ½æ”¾åˆ°å†…å­˜é‡Œé¢ï¼Œä¸€èˆ¬ä¼šæƒ³åˆ°çš„å°±æ˜¯é€šè¿‡æµå¼çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å¤§å¤§é™ä½å†…å­˜å ç”¨äº†ï¼Œå¦ä¸€ä¸ªå¼€æºçš„å›¾ç‰‡å¤„ç†åº“<a class=link href=https://github.com/libvips/libvips target=_blank rel=noopener>libvips</a> å°±æ˜¯è¿™æ ·åšçš„ï¼Œä½†æ˜¯å°† ImageMagick æ”¹é€ æˆæµå¼å¤„ç†çš„è¯è¿™ä¸ªå·¥ä½œé‡å°±è¿‡å¤§äº†ã€‚å¯¹äº jpeg è¿™ç§å›¾ç‰‡æ ¼å¼è¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼å°±æ˜¯å¯ä»¥åœ¨è§£å‹åƒç´ çš„æ—¶å€™åšåˆ°ç±»ä¼¼ç¼©æ”¾çš„åŠŸèƒ½ï¼Œè¿™é‡Œå°±è¦ç‰µæ‰¯åˆ° jpeg çš„å·¥ä½œåŸç†äº†ï¼Œjpeg çš„å‹ç¼©ç®—æ³•åŸºäº<a class=link href=https://zh.wikipedia.org/wiki/%E7%A6%BB%E6%95%A3%E4%BD%99%E5%BC%A6%E5%8F%98%E6%8D%A2 target=_blank rel=noopener>ç¦»æ•£ä½™å¼¦å˜æ¢</a>ï¼Œè¿™é‡Œæ‰“ä¸ªæ¯”æ–¹å¯ä»¥ç†è§£ä¸º jpeg å°†åƒç´ å­˜å‚¨åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå½“è§£å‹çš„æ—¶å€™è¾“å…¥åƒç´ çš„ä¸‹æ ‡å°±èƒ½è·å¾—è¿™ä¸ªåƒç´ åŸå§‹çš„æ•°æ®ï¼Œæ¯”å¦‚å¯¹äºä¸€ä¸ª 1000x1000 çš„å›¾ç‰‡ï¼Œæˆ‘å¸Œæœ›åœ¨è§£å‹æˆä¸€å¼  500*500 å›¾ç‰‡ï¼Œé‚£æ ·åœ¨è§£å‹æ—¶æˆ‘åªè¦è·³è¿‡é‚£äº›æˆ‘ä¸éœ€è¦çš„åƒç´ ç‚¹å°±å¥½äº†ï¼Œå½“æ—¶å®é™…æƒ…å†µæ›´åŠ å¤æ‚ï¼Œjpeg ä¹Ÿä¸æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªå‡½æ•°ä¸­çš„ã€‚è¿™é‡Œæ¨èä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç» jpeg å·¥ä½œåŸç†çš„è§†é¢‘ <a class=link href="https://www.youtube.com/watch?v=f2odrCGjOFY" target=_blank rel=noopener>How JPEG works</a></p><p>æœ‰äº†è¿™æ ·çš„ç†è®ºåŸºç¡€æˆ‘ä»¬å°±å¯ä»¥å®è·µäº†ï¼Œå…¶å® <code>libjpeg</code> å·²ç»æä¾›äº†è¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥å†è§£å‹ jpeg çš„æ—¶å€™æŒ‡å®šç¼©æ”¾çš„æ¯”ä¾‹ï¼Œæ¯”ä¾‹æœ‰å›ºå®šçš„æ¡£ä½åœ¨ 1~8 ä¹‹é—´ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å°åªèƒ½ç¼©æ”¾åˆ°åŸå›¾çš„é•¿å®½çš„å…«åˆ†ä¹‹ä¸€ã€‚ åœ¨ ImageMagick ä¸­è®¾ç½®è¿™ä¸ªå‚æ•°çš„æ–¹å¼æœ‰ç‚¹è¯¡å¼‚ï¼Œä»£ç å¦‚ä¸‹ï¼Œè¿™é‡ŒæŒ‡å®š <code>jpeg:size</code> å…¶å®åªæ˜¯æŒ‡å®šäº†ä¸€ä¸ªæœŸæœ›å€¼å®é™…è·å¾—çš„å›¾ç‰‡å¤§å°ä¼šæ˜¯ä¸€ä¸ªå¤§äºç›®æ ‡å°ºå¯¸çš„æœ€å°å€¼ï¼Œæ¯”å¦‚è¿™æ¬¡æµ‹è¯•çš„å›¾ç‰‡å®é™…è·å¾—çš„å›¾ç‰‡å¤§å°æ˜¯ 3000x2160ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>Magick<span style=color:#f92672>::</span>Image im;
MagickCore<span style=color:#f92672>::</span>ImageInfo<span style=color:#f92672>*</span> im_info <span style=color:#f92672>=</span> im.imageInfo();
im_info<span style=color:#f92672>-&gt;</span>options <span style=color:#f92672>=</span> MagickCore<span style=color:#f92672>::</span>NewSplayTree(MagickCore<span style=color:#f92672>::</span>CompareSplayTreeString, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)) <span style=color:#66d9ef>nullptr</span>, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)) <span style=color:#66d9ef>nullptr</span>);
MagickCore<span style=color:#f92672>::</span>AddValueToSplayTree((MagickCore<span style=color:#f92672>::</span>SplayTreeInfo<span style=color:#f92672>*</span>)(im_info<span style=color:#f92672>-&gt;</span>options), <span style=color:#e6db74>&#34;jpeg:size&#34;</span>, <span style=color:#e6db74>&#34;400x288&#34;</span>);
im.read(<span style=color:#e6db74>&#34;big-img.jpeg&#34;</span>);
im.filterType(Magick<span style=color:#f92672>::</span>LanczosFilter);
im.resize(Magick<span style=color:#f92672>::</span>Geometry(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>288</span>));
im.write(<span style=color:#e6db74>&#34;shrink-on-load.jpeg&#34;</span>);
</code></pre></div><p>ä¼˜åŒ–ä¹‹åè€—æ—¶é™ä½åˆ°äº† 0.4s å·¦å³ï¼Œå†…å­˜ä¹Ÿé™åˆ°äº† 100Mï¼ è€Œä¸”æœ€ç»ˆè¾“å‡ºçš„ç»“æœä¸ç›´æ¥è¿›è¡Œ <code>resize</code> çš„ç»“æœä»è‚‰çœ¼ä¸ŠåŸºæœ¬æ²¡æœ‰å·®è·</p><pre><code>User time (seconds): 0.42
System time (seconds): 0.02
Percent of CPU this job got: 99%
Maximum resident set size (kbytes): 104656
</code></pre><p>è§£å‹æ—¶ç¼©æ”¾ç»“æœ</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=shrink-on-load.jpeg></a><figcaption>shrink-on-load.jpeg</figcaption></figure></p><p>ç›´æ¥ <code>resize</code> ç»“æœ</p><p><figure class=gallery-image style=flex-grow:138;flex-basis:333px><a href=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg data-size=400x288><img src=/2020/10/11/imagemagick-tuning/shrink-on-load.jpeg width=400 height=288 srcset="/2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_480x0_resize_q75_box.jpeg 480w, /2020/10/11/imagemagick-tuning/shrink-on-load_hu80e10e32ba5b77d6eeb4656f1c5ccdee_49050_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=shrink-on-load.jpeg></a><figcaption>shrink-on-load.jpeg</figcaption></figure></p><h3 id=é¢˜å¤–è¯>é¢˜å¤–è¯</h3><p>å› ä¸º ImageMagick ä¸æ”¯æŒ SIMD åŠ é€Ÿåœ¨æµ‹è¯•çš„è¿‡ç¨‹æˆ‘ä¹Ÿå°è¯•è¿‡ä½¿ç”¨æ”¯æŒ SIMD åŠ é€Ÿçš„å›¾ç‰‡åº“æ¯”å¦‚ <a class=link href=https://github.com/uploadcare/pillow-simd target=_blank rel=noopener>pillow-simd</a> å¤„ç†å®Œæ•´åˆ†è¾¨ç‡çš„å›¾åƒä¹ŸåŸºæœ¬èƒ½æ§åˆ¶åœ¨ 1s çº§åˆ«ï¼Œä¸èƒ½åˆ©ç”¨ç°ä»£ CPU çš„åŠŸèƒ½æ˜¯ ImageMagick çš„ç¡¬ä¼¤</p><h3 id=æ€»ç»“>æ€»ç»“</h3><p>è¿™æ¬¡ç¼©ç•¥å›¾çš„ä¼˜åŒ–ï¼Œå¯¹äºè¿™ç§è¶…å¤§åˆ†è¾¨ç‡çš„å›¾ç‰‡å¤„ç†é€Ÿåº¦æå‡äº†ä¸€ä¸ªæ•°é‡çº§ (10s -> 0.5s) åŒæ—¶å†…å­˜å ç”¨ä¹Ÿé™åˆ°äº†ä¸€ä¸ªæ•°é‡çº§ (4G -> 100M)ã€‚åŸºæœ¬ä¸Šè¾¾åˆ°äº†åœ¨çº¿æœåŠ¡çš„èƒ½åŠ›ã€‚è¿™ä¸ªæ•…äº‹å‘Šè¯‰æˆ‘ä»¬æ²¡äº‹åˆ«å»é‡æ„è€æœåŠ¡ğŸ˜…</p><h3 id=å‚è€ƒ>å‚è€ƒ</h3><ul><li><a class=link href=http://www.imagemagick.org/Usage/thumbnails/ target=_blank rel=noopener>Imagemagick thumbnails/</a></li><li><a class=link href=https://libjpeg-turbo.org/ target=_blank rel=noopener>libjpeg-turbo.org/</a></li><li><a class=link href=https://stackoverflow.com/questions/42022982/imagemagick-single-convert-command-performance target=_blank rel=noopener>Imagemagick Single Convert Command Performance</a></li><li><a class=link href="https://www.youtube.com/watch?v=f2odrCGjOFY" target=_blank rel=noopener>How JPEG works</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/imagemagick.html>ImageMagick</a>
<a href=/tags/jpeg.html>jpeg</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//tomwei7.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2016 -
2021 å›´åŸ</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ul><li><ul><li><a href=#é—®é¢˜é‡ç°>é—®é¢˜é‡ç°</a></li><li><a href=#ä»-imagemagick-å…¥æ‰‹>ä» ImageMagick å…¥æ‰‹</a></li><li><a href=#ä»-jpeg-æ ¼å¼å…¥æ‰‹>ä» jpeg æ ¼å¼å…¥æ‰‹</a></li><li><a href=#é¢˜å¤–è¯>é¢˜å¤–è¯</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li><li><a href=#å‚è€ƒ>å‚è€ƒ</a></li></ul></li></ul></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script></body></html>